openapi: 3.0.0
info:
  title: Loyalty API
  version: 1.0.0

paths:
  /user/web:
    post:
      summary: Регистрация пользователя по имени пользователя и паролю
      tags:
        - User
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CredentialsForm"
      responses:
        "200":
          description: Успешно
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "409":
          description: Пользователь с таким именем уже существует
        "401":
          description: Не авторизован

  /user/login:
    post:
      summary: Логин
      tags:
        - User
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CredentialsForm"
      responses:
        "200":
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessToken"
        "422":
          description: Неверный запрос
        "403":
          description: Ошибка входа (неправильные учетные данные)

  /user/:
    get:
      summary: Информация о пользователе (нужна авторизация)
      tags:
        - User
      security:
        - bearer: []
      responses:
        "200":
          description: Информация о пользователе
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Не авторизован

  /user/logout:
    delete:
      summary: Логаут пользователя (удаление всех токенов доступа, нужна авторизация)
      tags:
        - User
      security:
        - bearer: []
      responses:
        "204":
          description: Пользователь вышел
        "401":
          description: Не авторизован

  /client/:
    get:
      summary: Информация о клиенте
      description: "Требуемая роль: Client"
      security:
        - bearer: []
      tags:
        - Client
      responses:
        "200":
          description: Информация о клиенте
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Client"
        "403":
          description: Доступ запрещен (недоступна роль Client)
        "401":
          description: Не авторизован
    post:
      security:
        - bearer: []
      summary: Создать нового клиента (нужна авторизация)
      tags:
        - Client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientForm"
      responses:
        "204":
          description: Клиент успешно создан
        "422":
          description: Неверный запрос 
        "401":
          description: Не авторизован

  /business/:
    post:
      security:
        - bearer: []
      summary: Создать новый бизнес (нужна авторизация)
      tags:
        - Business
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BusinessForm"
      responses:
        "204":
          description: Бизнес успешно создан
        "422":
          description: Неверный запрос
        "409":
          description: Бизнес с таким названием уже существует
        "401":
          description: Не авторизован

  /business/{business_id}:
    get:
      summary: Информация о бизнесе
      description: "Требуемая роль: Business"
      security:
        - bearer: []
      parameters:
        - name: business_id
          in: path
          required: true
      tags:
        - Business
      responses:
        "200":
          description: Информация о бизнесе
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Business"
        "403":
          description: Доступ запрещен
        "404":
          description: Бизнес не найден
        "401":
          description: Не авторизован

  /branch:
    post:
      summary: Создать новый филиал для текущего бизнеса
      description: "Требуемая роль: Business"
      tags:
        - Branch
      security:
        - bearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BusinessBranchForm"
      responses:
        "200":
          description: Филиал успешно создан
        "422":
          description: Неверный запрос
        "401":
          description: Не авторизован

  /branch/{business_branch_id}:
    put:
      summary: Обновить филиал (нужно быть бизнесом который владеет этим филиалом)
      description: "Требуемая роль: Business"
      tags:
        - Branch
      security:
        - bearer: []
      parameters:
        - name: business_branch_id
          in: path
          required: true
          description: ID филиала для обновления
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BusinessBranchForm"
      responses:
        "204":
          description: Филиал успешно обновлен
        "403":
          description: Доступ запрещен
        "404":
          description: Филиал не найден
        "401":
          description: Не авторизован
    delete:
      summary: Удалить филиал (нужно быть владельцем филиала)
      description: "Требуемая роль: Business"
      tags:
        - Branch
      security:
        - bearer: []
      parameters:
        - name: business_branch_id
          in: path
          required: true
          description: ID филиала для удаления
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Филиал успешно удален
        "403":
          description: Доступ запрещен
        "404":
          description: Филиал не найден
        "401":
          description: Не авторизован
    get:
      summary: Получить информацию о филиале
      description: "Требуемая роль: Client или Business"
      tags:
        - Branch
      security:
        - bearer: []
      parameters:
        - name: business_branch_id
          in: path
          required: true
          description: ID филиала
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Информация о филиале
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BusinessBranch"
        "403":
          description: Доступ запрещен
        "404":
          description: Филиал не найден
        "401":
          description: Не авторизован

  /business/{business_id}/branch:
    get:
      summary: Получить все филиалы бизнеса
      description: "Требуемая роль: Client или Business"
      tags:
        - Business branch
      security:
        - bearer: []
      parameters:
        - name: business_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: offset
          in: query
          required: false
          description: Смещение пагинации
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          required: false
          description: Максимальное количество возвращаемых элементов
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Список филиалов бизнеса
          content:
            application/json:
              schema:
                type: object
                properties:
                  branches:
                    type: array
                    items:
                      $ref: "#/components/schemas/BusinessBranch"
        "403":
          description: Доступ запрещен
        "401":
          description: Не авторизован

  /loyalty/:
    post:
      summary: Создать новую программу лояльности
      description: "Требуемая роль: Business"
      tags:
        - Loyalty
      security:
        - bearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoyaltyForm"
      responses:
        "200":
          description: Программа лояльности успешно создана
          content:
            application/json:
              schema:
                type: object
                properties:
                  loyalty_id:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
        "400":
          description: Неверные параметры даты. Дата окончания раньше даты начала
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "409":
          description: Программа лояльности уже существует
        "422":
          description: Ошибка валидации

    get:
      summary: Получить список программ лояльности
      description: "Требуемая роль: Client или Business"
      tags:
        - Loyalty
      security:
        - bearer: []
      parameters:
        - name: offset
          in: query
          description: Смещение пагинации
          required: false
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          description: Лимит пагинации
          required: false
          schema:
            type: integer
            default: 10
        - name: active
          in: query
          description: Фильтр по статусу активности. Доступно только для программ вашего бизнеса
          schema:
            type: boolean
        - name: time_frame
          in: query
          description: Фильтр по временному периоду (АКТУАЛЬНЫЕ/ВСЕ)
          schema:
            type: string
            enum: ["CURRENT", "ALL"]
            default: "ALL"
        - name: business_id
          in: query
          description: Фильтр по ID бизнеса. Бизнес может просматривать только свои программы
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Список программ лояльности
          content:
            application/json:
              schema:
                type: object
                properties:
                  loyalties:
                    type: array
                    items:
                      $ref: "#/components/schemas/Loyalty"
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "422":
          description: Неверная пагинация

  /loyalty/{loyalty_id}:
    get:
      summary: Получить детали программы лояльности (для клиентов и программ вашего бизнеса)
      description: "Требуемая роль: Client или Business"
      tags:
        - Loyalty
      security:
        - bearer: []
      parameters:
        - name: loyalty_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Детали программы лояльности
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Loyalty"
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "404":
          description: Программа лояльности не найдена

    put:
      summary: Обновить программу лояльности вашего бизнеса
      description: "Требуемая роль: Business"
      tags:
        - Loyalty
      security:
        - bearer: []
      parameters:
        - name: loyalty_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateLoyaltyForm"
      responses:
        "204":
          description: Программа лояльности успешно обновлена
        "400":
          description: Неверные параметры даты. Дата окончания раньше даты начала
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "404":
          description: Программа лояльности не найдена
        "422":
          description: Ошибка валидации

    delete:
      summary: Удалить программу лояльности вашего бизнеса
      description: "Требуемая роль: Business"
      tags:
        - Loyalty
      security:
        - bearer: []
      parameters:
        - name: loyalty_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Программа лояльности успешно удалена
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "404":
          description: Программа лояльности не найдена

  /membership/:
    post:
      summary: Создать новое участие в программе лояльности (только для клиента)
      description: "Требуемая роль: Client"
      tags:
        - Membership
      security:
        - bearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MembershipForm"
      responses:
        "200":
          description: Участие успешно создано
          content:
            application/json:
              schema:
                type: object
                properties:
                  membership_id:
                    type: string
                    format: uuid
        "401":
          description: Не авторизован
        "422":
          description: Ошибка валидации
        "404":
          description: Программа лояльности не существует
        "403":
          description: Клиент не соответствует таргетингу
        "409":
          description: Участие уже существует

    get:
      summary: Получить список текущих участий клиента (только для клиента)
      description: "Требуемая роль: Client"
      tags:
        - Membership
      security:
        - bearer: []
      parameters:
        - name: offset
          in: query
          description: Смещение пагинации
          required: false
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          description: Лимит пагинации
          required: false
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Список участий клиента
          content:
            application/json:
              schema:
                type: object
                properties:
                  loyalties:
                    type: array
                    items:
                      $ref: "#/components/schemas/LoyaltyMembership"
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "422":
          description: Неверная пагинация (limit < 0 или offset < 0) или limit превышает максимальный лимит

  /membership/{membership_id}/:
    delete:
      summary: Удалить участие (только для клиента и только в тех программах, где он участвует)
      description: "Требуемая роль: Client"
      tags:
        - Membership
      security:
        - bearer: []
      parameters:
        - name: membership_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Участие успешно удалено
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "404":
          description: Участие не найдено
    get:
      summary: Получить информацию об участии (только для клиента и только в тех программах, где он участвует)
      description: "Требуемая роль: Client"
      tags:
        - Membership
      security:
        - bearer: []
      parameters:
        - name: membership_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Детали участия
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoyaltyMembership"
        "401":
          description: Не авторизован
        "403":
          description: Доступ запрещен
        "404":
          description: Участие не найдено

components:
  securitySchemes:
    bearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Токен авторизации (доступа)
  schemas:
    CredentialsForm:
      type: object
      description: Учетные данные пользователя
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 100
          example: "business"
        password:
          type: string
          minLength: 6
          maxLength: 100
          example: "securePassword123"
          format: password

    ClientForm:
      type: object
      description: Форма создания клиента
      required:
        - full_name
        - age
        - gender
        - phone
        - lon
        - lat
      properties:
        full_name:
          type: string
          minLength: 4
          maxLength: 250
          example: "Иван Иванов"
        age:
          type: integer
          minimum: 0
          maximum: 100
          example: 30
        gender:
          type: string
          enum: ["MALE", "FEMALE", "OTHER"]
          example: "MALE"
        phone:
          type: string
          example: "+79281859225"
        lon:
          type: float
          minimum: -90
          maximum: 90
          example: 37.6156
          description: "Долгота"
        lat:
          type: float
          minimum: -180
          maximum: 180
          example: 55.7522
          description: "Широта"

    BusinessForm:
      type: object
      description: Форма создания бизнеса
      required:
        - name
        - contact_email
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 250
          example: "ООО БНАЛ"
        contact_phone:
          type: string
          example: "+79281659225"
          description: "Контактный номер телефона бизнеса"
        contact_email:
          type: string
          format: email
          example: "structnull@yandex.ru"
          description: "Контактная электронная почта бизнеса"

    Client:
      type: object
      description: Информация о клиенте
      required:
        - client_id
        - full_name
        - age
        - gender
        - phone
        - lon
        - lat
        - created_at
      properties:
        client_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        full_name:
          type: string
          example: "Иван Иванов"
        age:
          type: integer
          example: 30
        gender:
          type: string
          enum: ["MALE", "FEMALE"]
          example: "MALE"
        phone:
          type: string
          example: "+79281559535"
        lon:
          type: float
          example: 37.6156
        lat:
          type: float
          example: 55.7522
        created_at:
          type: string
          format: date-time

    Business:
      type: object
      description: Информация о бизнесе
      required:
        - business_id
        - name
        - contact_email
        - contact_phone
        - lon
        - lat
        - created_at
      properties:
        business_id:
          type: string
          format: uuid
          example: "550e8400-e29b-49d4-a716-446655440000"
        name:
          type: string
          example: "ООО Бнал"
        contact_phone:
          type: string
          nullable: true
          example: "+79281559535"
        contact_email:
          type: string
          format: email
          example: "+79281559535"
        lon:
          type: float
          example: 37.6156
        lat:
          type: float
          example: 55.7522
        created_at:
          type: string
          format: date-time

    User:
      type: object
      description: Информация о пользователе
      required:
        - client
        - user_id
        - business
      properties:
        client:
          $ref: "#/components/schemas/Client"
        business:
          $ref: "#/components/schemas/Business"
        user_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    AccessToken:
      type: object
      description: Токен доступа
      required:
        - token
        - user_id
      properties:
        user_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        token:
          type: string

    BusinessBranchForm:
      type: object
      description: Форма создания филиала
      required:
        - name
        - lon
        - lat
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 250
          example: "Название филиала"
        lon:
          type: number
          format: float
          example: 37.6156
          description: "Долгота"
        lat:
          type: number
          format: float
          example: 55.7522
          description: "Широта"
        contact_phone:
          type: string
          example: "+79281659225"

    BusinessBranch:
      type: object
      description: Филиал
      required:
        - business_branch_id
        - business
        - name
        - contact_phone
        - lon
        - lat
        - created_at
      properties:
        business_branch_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        business:
          $ref: "#/components/schemas/Business"
        name:
          type: string
          example: "Название филиала"
        contact_phone:
          type: string
          nullable: true
          example: "+79281659225"
        lon:
          type: number
          format: float
          example: 37.6156
        lat:
          type: number
          format: float
          example: 55.7522

    Loyalty:
      type: object
      description: Программа лояльности
      properties:
        loyalty_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Программа лояльности"
        description:
          type: string
          example: "Описание программы"
        starts_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата меньше этого поля"
        ends_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата больше или равна дате этого поля"
        money_per_bonus:
          type: float
          minimum: 0.1
          example: 1
          description: "За сколько рублей клиент получает один бонус"
        money_for_bonus:
          type: float
          minimum: 0.1
          example: 1.0
          description: "Cколько рублей скидки клиент получает за 1 бонус"
        min_age:
          type: integer
          example: 18
          description: "Минимальный возраст клиента, при котором он может просматривать данную программу"
        max_age:
          type: integer
          example: 99
          description: "Максимальный возраст клиента, при котором он может просматривать данную программу"
        is_active:
          type: boolean
          example: true
          description: "Доступна ли сейчас программа к просмотру пользователем"
        gender:
          type: string
          nullable: true
          enum:
            - "MALE"
            - "FEMALE"
            - null
          example: "MALE"
          description: "Пол клиентов, которые могут просматривать эту программу лояльности. При значении null программу можно просматривать вне зависимости от пола пользователя"
        business:
          $ref: "#/components/schemas/Business"
        business_branches:
          type: array
          items:
            $ref: "#/components/schemas/BusinessBranch"
          description: "Список филиалов бизнеса, которые участвуют в данной программе лояльности"
        created_at:
          type: string
          format: date-time

    LoyaltyForm:
      type: object
      description: Форма создания программы лояльности
      required:
        - name
        - description
        - starts_at
        - ends_at
        - money_per_bonus
        - min_age
        - max_age
        - business_branches_id_list
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          example: "Программа лояльности"
        description:
          type: string
          maxLength: 950
          example: "Описание программы"
        starts_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата меньше этого поля"
        ends_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата больше или равна дате этого поля"
          example: "2030-05-10T19:26:32.586Z"
        money_per_bonus:
          type: float
          minimum: 0.1
          example: 1
          description: "За сколько рублей клиент получает один бонус"
        money_for_bonus:
          type: float
          minimum: 0.1
          example: 1.0
          description: "Cколько рублей скидки клиент получает за 1 бонус"
        min_age:
          type: integer
          minimum: 14
          maximum: 120
          example: 18
          description: "Минимальный возраст клиента, при котором он может просматривать данную программу"
        max_age:
          type: integer
          minimum: 14
          maximum: 120
          example: 99
          description: "Максимальный возраст клиента, при котором он может просматривать данную программу"
        business_branches_id_list:
          type: array
          items:
            type: string
            format: uuid
          example: ["550e8400-e29b-41d4-a716-446655440000"]
          description: "Список ID филиалов бизнеса, которые участвуют в данной программе лояльности"
        gender:
          type: string
          nullable: true
          enum:
            - "MALE"
            - "FEMALE"
            - null
          example: "MALE"
          description: "Пол клиентов, которые могут просматривать эту программу лояльности. При значении null программу можно просматривать вне зависимости от пола пользователя"

    UpdateLoyaltyForm:
      type: object
      description: Форма обновления программы лояльности
      required:
        - name
        - description
        - starts_at
        - ends_at
        - is_active
        - money_per_bonus
        - business_branches_id_list
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          example: "Обновленная программа"
        description:
          type: string
          maxLength: 950
          example: "Новое описание"
        starts_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата меньше этого поля"
        ends_at:
          type: string
          format: date-time
          description: "Программа не активна, если текущая дата больше или равна дате этого поля"
          example: "2030-05-10T19:26:32.586Z"
        is_active:
          type: boolean
          example: true
          description: "Доступна ли сейчас программа к просмотру пользователем"
        money_per_bonus:
          type: float
          minimum: 0.1
          example: 1
          description: "За сколько рублей клиент получает один бонус"
        money_for_bonus:
          type: float
          minimum: 0.1
          example: 1.0
          description: "Cколько рублей скидки клиент получает за 1 бонус"
        business_branches_id_list:
          type: array
          items:
            type: string
            format: uuid
          example: ["550e8400-e29b-41d4-a716-446655440000"]
          description: "Список ID филиалов бизнеса, которые участвуют в данной программе лояльности"

    ErrorResponse:
      description: Ошибка запроса
      type: object
      properties:
        description:
          type: string
          example: "Программа лояльности не существует"
        unique_code:
          type: string
          example: "LOYALTY_DOES_NOT_EXIST"

    ValidationError:
      description: Ошибка валидации
      type: object
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
              msg:
                type: string
              type:
                type: string

    MembershipForm:
      description: Форма участия в программе лояльности
      type: object
      required:
        - loyalty_id
      properties:
        loyalty_id:
          type: string
          format: uuid

    LoyaltyMembership:
      description: Участие в программе лояльности
      type: object
      required:
        - membership_id
        - loyalty
        - client
        - created_at
      properties:
        membership_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        client:
          $ref: "#/components/schemas/Client"
        loyalty:
          $ref: "#/components/schemas/Loyalty"